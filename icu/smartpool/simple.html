<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简单页面</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: center;
            vertical-align: middle;
        }

        pre.centered {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            text-align: center;
        }

        select {
            padding: 4px 6px;
        }
    </style>
</head>
<body>
<h1>简单页面</h1>
<div style="margin-bottom:12px;">
    <label for="stage-select">选择阶段：</label>
    <select id="stage-select" disabled>
        <option value="">加载中...</option>
    </select>
</div>

<section id="lists-section" style="margin-top:16px; display:none;">
    <p><strong>初始币对列表：</strong><span id="symbol-list">加载中...</span></p>
    <p><strong>双币币对列表：</strong><span id="pair-list">加载中...</span></p>
</section>

<div id="content" style="margin-top:16px;">请选择阶段</div>
<table id="stage-table" border="1" cellpadding="6" cellspacing="0" style="margin-top:12px; display: none;">
    <thead>
    <tr id="stage-header"></tr>
    </thead>
    <tbody></tbody>
</table>
<script>
    const stageSelect = document.getElementById('stage-select');
    const container = document.getElementById('content');
    const table = document.getElementById('stage-table');
    const theadRow = document.getElementById('stage-header');
    const tbody = table.querySelector('tbody');
    const listsSection = document.getElementById('lists-section');
    const symbolListSpan = document.getElementById('symbol-list');
    const pairListSpan = document.getElementById('pair-list');

    const STAGE_OPTIONS = [
        {label: '初始结果', value: 'initial-results', stage: 'rltArr'},
        {label: '过滤后币种', value: 'center-list', stage: 'centerList'},
        {label: '高位列表', value: 'high-list', stage: 'highList'},
        {label: '低位列表', value: 'low-list', stage: 'lowList'},
        {label: '最终结果', value: 'final-results', stage: 'data'}
    ];
    const DEFAULT_STAGE = 'center-list';

    function buildTableHeader(keys) {
        theadRow.innerHTML = keys.map(key => `<th>${key}</th>`).join('');
    }

    function renderStage(stagePath, stageLabel) {
        if (!stagePath) {
            container.textContent = '请选择阶段';
            table.style.display = 'none';
            return;
        }
        fetch(`/api/data/${stagePath}`)
            .then(resp => resp.json())
            .then(({data, savedAt, batchTimestamp, stage}) => {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    container.textContent = `阶段 ${stageLabel || stage} 暂无数据`;
                    table.style.display = 'none';
                    return;
                }
                const sorted = data.slice().sort((a, b) => {
                    if (typeof a === 'object' && typeof b === 'object' && 'score' in a && 'score' in b) {
                        return Number(b.score || 0) - Number(a.score || 0);
                    }
                    return 0;
                });
                const keys = Object.keys(sorted[0]);
                container.innerHTML = `
                    <p><strong>批次时间：</strong>${batchTimestamp || '未知'}</p>
                    <p><strong>阶段：</strong>${stageLabel || stage}</p>
                    <p><strong>保存时间：</strong>${savedAt ? new Date(savedAt).toLocaleString() : '未知'}</p>
                    <p><strong>记录数：</strong>${sorted.length}</p>
                `;
                buildTableHeader(keys);
                tbody.innerHTML = '';
                sorted.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = keys.map(key => {
                        const cellVal = row[key];
                        const text = typeof cellVal === 'object' ? JSON.stringify(cellVal, null, 2) : String(cellVal);
                        return `<td><pre class="centered">${text}</pre></td>`;
                    }).join('');
                    tbody.appendChild(tr);
                });
                table.style.display = '';
            })
            .catch(err => {
                container.textContent = '阶段数据加载失败: ' + err;
                table.style.display = 'none';
            });
    }

    function loadSymbolAndPairs() {
        Promise.all([
            fetch('/api/data/symbol-list').then(res => res.json()).catch(() => null),
            fetch('/api/data/pairs').then(res => res.json()).catch(() => null)
        ]).then(([symbolResp, pairResp]) => {
            symbolListSpan.textContent = symbolResp && Array.isArray(symbolResp.data) ? symbolResp.data.join(', ') : '无数据';
            pairListSpan.textContent = pairResp && Array.isArray(pairResp.data) ? pairResp.data.join(', ') : '无数据';
            listsSection.style.display = '';
        });
    }

    fetch('/api/data')
        .then(resp => resp.json())
        .then(summary => {
            let fallbackStage = null;
            const optionsHtml = STAGE_OPTIONS.map(opt => {
                const stageInfo = summary.stageSummary.find(item => item.stage === opt.stage);
                const disabled = !stageInfo || stageInfo.size === 0;
                if (!disabled && !fallbackStage) {
                    fallbackStage = opt;
                }
                const selected = !disabled && opt.value === DEFAULT_STAGE ? 'selected' : '';
                const label = `${opt.label}${stageInfo && stageInfo.savedAt ? ` (${new Date(stageInfo.savedAt).toLocaleString()})` : ''}`;
                return `<option value="${opt.value}" ${disabled ? 'disabled' : ''} ${selected}>${label}</option>`;
            });
            stageSelect.innerHTML = optionsHtml.join('');
            stageSelect.disabled = false;
            loadSymbolAndPairs();

            stageSelect.addEventListener('change', () => {
                const selectedValue = stageSelect.value;
                const optionMeta = STAGE_OPTIONS.find(opt => opt.value === selectedValue);
                if (!selectedValue || !optionMeta) {
                    container.textContent = '请选择阶段';
                    table.style.display = 'none';
                    return;
                }
                renderStage(selectedValue, optionMeta.label);
            });

            const initialOption = STAGE_OPTIONS.find(opt => opt.value === DEFAULT_STAGE);
            const initialStage = initialOption && stageSelect.querySelector(`option[value="${DEFAULT_STAGE}"]`) && !stageSelect.querySelector(`option[value="${DEFAULT_STAGE}"]`).disabled
                ? initialOption
                : fallbackStage;
            if (initialStage) {
                stageSelect.value = initialStage.value;
                renderStage(initialStage.value, initialStage.label);
            }
        })
        .catch(err => {
            container.textContent = '数据加载失败: ' + err;
            stageSelect.innerHTML = '<option value="">加载失败</option>';
            stageSelect.disabled = true;
        });
</script>
</body>
</html>
