<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>网格订单统计面板</title>
    <style>
        :root {
            color-scheme: dark;
            font-family: "Segoe UI", Roboto, Arial, sans-serif;
            background-color: #0f1624;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            background: #0f1624;
            color: #e0e6f1;
        }

        a {
            color: #64b5f6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 12px 24px;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            letter-spacing: 0.4px;
        }

        header .meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #90a4c1;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions label {
            font-size: 14px;
            color: #90a4c1;
        }

        .header-actions select {
            appearance: none;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #1f2a48;
            background: #111b2d;
            color: #e0e6f1;
            font-size: 14px;
            min-width: 220px;
        }

        .header-actions select:focus {
            outline: none;
            border-color: #3d8bfd;
            box-shadow: 0 0 0 2px rgba(61, 139, 253, 0.25);
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: #111b2d;
            border: 1px solid #1f2a48;
            border-radius: 10px;
            padding: 16px 18px;
            box-shadow: 0 0 18px rgba(10, 14, 26, 0.45);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 8px;
            background: rgba(36, 45, 68, 0.55);
            border: 1px solid rgba(63, 81, 128, 0.45);
        }

        .asset-overview {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .asset-overview-header {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            align-items: baseline;
            font-size: 13px;
            color: #8fa3bf;
        }

        .asset-overview-header strong {
            font-size: 15px;
            color: #e0e6f1;
        }

        .asset-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .asset-metric {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 8px;
            background: rgba(36, 45, 68, 0.55);
            border: 1px solid rgba(63, 81, 128, 0.45);
        }

        .asset-metric-label {
            font-size: 12px;
            letter-spacing: 0.6px;
            color: #8fa3bf;
            text-transform: uppercase;
        }

        .asset-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: #e0e6f1;
        }

        .asset-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .asset-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 14px 16px;
            border-radius: 10px;
            background: rgba(27, 37, 59, 0.75);
            border: 1px solid rgba(47, 65, 102, 0.6);
        }

        .asset-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
        }

        .asset-card-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .asset-card-profit {
            font-size: 16px;
            font-weight: 600;
        }

        .asset-card-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px 12px;
        }

        .asset-card-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .asset-card-metric-label {
            font-size: 11px;
            letter-spacing: 0.4px;
            color: #8fa3bf;
            text-transform: uppercase;
        }

        .asset-card-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #e0e6f1;
        }

        .asset-card-footer {
            font-size: 12px;
            color: #90a4c1;
        }

        .asset-overview-footer {
            font-size: 12px;
            color: #90a4c1;
        }

        .summary-label {
            font-size: 12px;
            letter-spacing: 0.6px;
            color: #8fa3bf;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 600;
        }

        h2 {
            margin: 0 0 12px;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: rgba(45, 66, 104, 0.55);
        }

        th,
        td {
            padding: 8px 10px;
            border-bottom: 1px solid #1f2a48;
            text-align: left;
            white-space: nowrap;
        }

        tbody tr:nth-child(odd) {
            background: rgba(20, 30, 48, 0.6);
        }

        tbody tr:hover {
            background: rgba(63, 81, 128, 0.35);
        }

        .text-right {
            text-align: right;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-buy {
            background: rgba(56, 142, 60, 0.28);
            color: #9cdf7c;
        }

        .badge-sell {
            background: rgba(244, 67, 54, 0.28);
            color: #ffa4a2;
        }

        .timeline-table td {
            white-space: nowrap;
        }

        .placeholder {
            margin: 0;
            color: #90a4c1;
        }

        .symbol-summary {
            margin-bottom: 16px;
        }

        .symbol-summary-title {
            margin: 0 0 10px;
            font-size: 14px;
            color: #8fa3bf;
            letter-spacing: 0.4px;
        }

        .symbol-summary-table td,
        .symbol-summary-table th {
            white-space: nowrap;
        }

        .arbitrage-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .arbitrage-table th,
        .arbitrage-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(47, 65, 102, 0.6);
            white-space: nowrap;
            text-align: left;
        }

        .arbitrage-table .text-right {
            text-align: right;
        }

        .arbitrage-summary-row {
            cursor: pointer;
            background: rgba(20, 30, 48, 0.45);
            transition: background 0.2s, border 0.2s;
        }

        .arbitrage-summary-row:hover,
        .arbitrage-summary-row:focus-visible {
            background: rgba(40, 60, 96, 0.55);
        }

        .arbitrage-summary-row:focus-visible {
            outline: 2px solid rgba(61, 139, 253, 0.5);
            outline-offset: -2px;
        }

        .arbitrage-summary-row .arbitrage-summary-profit-cell {
            font-weight: 600;
        }

        .arbitrage-summary-row .arbitrage-id-cell {
            font-weight: 600;
            color: #e0e6f1;
        }

        .arbitrage-summary-row small {
            display: block;
            font-size: 11px;
            color: #8fa3bf;
        }

        .arbitrage-detail-row td {
            padding: 0;
            border-bottom: 1px solid rgba(47, 65, 102, 0.6);
            background: rgba(12, 18, 32, 0.75);
        }

        .section-indicator {
            margin: 0 0 12px;
            font-size: 13px;
            color: #8fa3bf;
        }

        .error {
            color: #ef9a9a;
        }

        .profit-positive {
            color: #9cdf7c;
        }

        .profit-negative {
            color: #ef9a9a;
        }

        .profit-neutral {
            color: #cfd8dc;
        }

        .profit-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .profit-metric {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 8px;
            background: rgba(36, 45, 68, 0.55);
            border: 1px solid rgba(63, 81, 128, 0.45);
        }

        .profit-label {
            font-size: 12px;
            letter-spacing: 0.6px;
            color: #8fa3bf;
            text-transform: uppercase;
        }

        .profit-value {
            font-size: 20px;
            font-weight: 600;
        }

        .profit-leaders {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
        }

        .leader-list {
            flex: 1 1 240px;
            min-width: 220px;
        }

        .leader-list h3 {
            margin: 0 0 10px;
            font-size: 15px;
            color: #90a4c1;
        }

        .leader-items {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leader-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(27, 37, 59, 0.65);
            border: 1px solid rgba(47, 65, 102, 0.6);
        }

        .leader-empty {
            color: #90a4c1;
        }

        .task-block {
            border: 1px solid #1f2a48;
            border-radius: 8px;
            background: rgba(17, 27, 45, 0.65);
            margin-bottom: 12px;
        }

        .task-block summary {
            cursor: pointer;
            padding: 12px 14px;
            padding-right: 40px;
            outline: none;
            position: relative;
            display: block;
        }

        .task-block summary::after {
            content: '⌄';
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #8fa3bf;
            transition: transform 0.2s;
        }

        .task-block[open] summary::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .task-block summary::-webkit-details-marker {
            display: none;
        }

        .task-block summary:focus-visible {
            box-shadow: 0 0 0 2px rgba(61, 139, 253, 0.4);
            border-radius: 8px 8px 0 0;
        }

        .arbitrage-detail {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .arbitrage-detail-legs {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .arbitrage-detail-rates {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: #90a4c1;
        }

        .task-header {
            display: flex;
            flex-wrap: wrap;
            gap: 14px 24px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .task-subtitle {
            margin: 2px 0 0;
            font-size: 13px;
            color: #8fa3bf;
            line-height: 1.4;
        }

        .task-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.4px;
            background: rgba(61, 139, 253, 0.25);
            color: #90caf9;
            text-transform: uppercase;
        }

        .status-running {
            background: rgba(56, 142, 60, 0.28);
            color: #9cdf7c;
        }

        .status-paused,
        .status-idle {
            background: rgba(255, 193, 7, 0.25);
            color: #ffe082;
        }

        .status-stopped,
        .status-finished {
            background: rgba(244, 67, 54, 0.28);
            color: #ffa4a2;
        }

        .status-error {
            background: rgba(236, 64, 122, 0.28);
            color: #f48fb1;
        }

        .status-unknown {
            background: rgba(100, 181, 246, 0.22);
            color: #bbdefb;
        }

        .grid-task-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .grid-task-chip {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(47, 65, 102, 0.6);
            background: rgba(27, 37, 59, 0.75);
            color: inherit;
            cursor: pointer;
            text-align: left;
            font: inherit;
            transition: border 0.2s, background 0.2s, transform 0.2s;
        }

        .grid-task-chip:hover {
            border-color: rgba(100, 181, 246, 0.7);
            background: rgba(33, 47, 75, 0.85);
        }

        .grid-task-chip.active {
            border-color: #3d8bfd;
            box-shadow: 0 0 16px rgba(61, 139, 253, 0.35);
            background: rgba(40, 60, 96, 0.9);
        }

        .grid-task-chip:focus-visible {
            outline: none;
            border-color: #3d8bfd;
            box-shadow: 0 0 0 2px rgba(61, 139, 253, 0.35);
        }

        .grid-chip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .grid-chip-title {
            font-size: 16px;
            font-weight: 600;
        }

        .grid-chip-line {
            font-size: 12px;
            color: #8fa3bf;
        }

        .grid-chip-profit {
            font-size: 13px;
            font-weight: 600;
        }

        .grid-task-chip.grid-task-chip--no-config .grid-chip-line {
            color: #b0bec5;
        }

        .grid-config {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .grid-config-section {
            background: rgba(20, 30, 48, 0.4);
            border: 1px solid rgba(47, 65, 102, 0.6);
            border-radius: 8px;
            padding: 12px;
        }

        .grid-config-title {
            margin: 0 0 8px;
            font-size: 13px;
            color: #8fa3bf;
            letter-spacing: 0.4px;
        }

        .grid-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px 16px;
        }

        .grid-config-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .config-label {
            font-size: 12px;
            color: #8fa3bf;
        }

        .config-value {
            font-size: 14px;
            font-weight: 500;
            color: #e0e6f1;
        }

        .task-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            align-items: flex-end;
        }

        .task-metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 140px;
            align-items: flex-end;
        }

        .metric-label {
            font-size: 12px;
            color: #8fa3bf;
            letter-spacing: 0.6px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
        }

        .task-block-content {
            padding: 0 14px 14px;
        }

        .rate-line {
            font-size: 12px;
            color: #90a4c1;
        }

        .rate-line + .rate-line {
            margin-top: 2px;
        }

        .arbitrage-orders-table-wrapper {
            overflow-x: auto;
        }

        .arbitrage-orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: rgba(27, 37, 59, 0.55);
            border: 1px solid rgba(47, 65, 102, 0.6);
            border-radius: 8px;
            overflow: hidden;
        }

        .arbitrage-orders-table thead {
            background: rgba(13, 20, 36, 0.8);
        }

        .arbitrage-orders-table th,
        .arbitrage-orders-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(47, 65, 102, 0.6);
            white-space: nowrap;
            text-align: left;
        }

        .arbitrage-orders-table th.text-right,
        .arbitrage-orders-table td.text-right {
            text-align: right;
        }

        .arbitrage-orders-table tbody tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 720px) {
            body {
                padding: 16px;
            }

            header h1 {
                font-size: 24px;
            }

            table {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>网格订单统计面板</h1>
    <div class="meta">
        <span id="last-refresh">最后更新：-</span>
        <span><a href="./home.html">返回分析平台</a></span>
    </div>
    <div class="header-actions">
        <label for="grid-task-selector">选择网格任务</label>
        <select id="grid-task-selector"></select>
    </div>
</header>
<main>
    <section class="card">
        <h2>网格任务概览</h2>
        <div class="selected-task-overview" id="selected-task-overview"></div>
        <p class="placeholder" hidden id="grid-task-empty">暂无网格任务。</p>
        <p class="section-indicator" id="task-filter-indicator">当前任务：-</p>
        <div id="task-hierarchy"></div>
        <p class="placeholder" hidden id="task-empty">暂无任务统计。</p>
    </section>
    <section class="card">
        <h2>整体概览</h2>
        <div class="summary-grid" id="summary"></div>
        <p class="placeholder" hidden id="summary-empty">暂无订单数据。</p>
    </section>
    <section class="card">
        <h2>利润概览</h2>
        <div class="profit-overview-grid">
            <div class="profit-metric">
                <span class="profit-label">总盈亏 (USDT)</span>
                <span class="profit-value" id="profit-total">-</span>
            </div>
            <div class="profit-metric">
                <span class="profit-label">平均单套利盈亏</span>
                <span class="profit-value" id="profit-average">-</span>
            </div>
            <div class="profit-metric">
                <span class="profit-label">盈利双币任务</span>
                <span class="profit-value" id="profit-positive-count">-</span>
            </div>
            <div class="profit-metric">
                <span class="profit-label">亏损或未平任务</span>
                <span class="profit-value" id="profit-negative-count">-</span>
            </div>
        </div>
        <div class="profit-leaders">
            <div class="leader-list">
                <h3>利润领先</h3>
                <ul class="leader-items" id="profit-winners"></ul>
            </div>
            <div class="leader-list">
                <h3>利润落后</h3>
                <ul class="leader-items" id="profit-losers"></ul>
            </div>
        </div>
    </section>
    <section class="card">
        <h2>最新成交</h2>
        <p class="section-indicator" id="timeline-filter-indicator">当前任务：-</p>
        <div class="table-wrapper">
            <table class="timeline-table">
                <thead>
                <tr>
                    <th>订单ID</th>
                    <th>方向</th>
                    <th>Symbol</th>
                    <th class="text-right">数量</th>
                    <th class="text-right">价格</th>
                    <th class="text-right">金额</th>
                    <th class="text-right">手续费</th>
                    <th>Maker占比</th>
                    <th>状态</th>
                    <th>时间</th>
                    <th>网格批次</th>
                </tr>
                </thead>
                <tbody id="timeline-table"></tbody>
            </table>
            <p class="placeholder" hidden id="timeline-empty">暂无订单。</p>
        </div>
    </section>
    <section class="card">
        <h2>数据源</h2>
        <p class="placeholder" id="source-meta">正在加载订单数据...</p>
        <p class="placeholder error" hidden id="error-message"></p>
    </section>
</main>
<script>
    const SUMMARY_CONFIG = [
        {label: '订单总数', key: 'totalOrders'},
        {label: '网格任务数', key: 'taskCount'},
        {label: '交易对数量', key: 'symbolCount'},
        {label: '买入总量', key: 'totalBuyQty', format: value => formatNumber(value, 4)},
        {label: '卖出总量', key: 'totalSellQty', format: value => formatNumber(value, 4)},
        {label: '买入名义金额', key: 'totalBuyNotional', format: value => formatNumber(value, 2)},
        {label: '卖出名义金额', key: 'totalSellNotional', format: value => formatNumber(value, 2)},
        {
            label: '名义盈亏',
            key: 'netProfit',
            format: value => formatNumber(value, 2),
            getClass: value => getProfitClass(value)
        },
        {label: '手续费总额', key: 'totalFee', format: value => formatNumber(value, 6)},
        {label: 'Maker手续费', key: 'makerFee', format: value => formatNumber(value, 6)},
        {label: 'Taker手续费', key: 'takerFee', format: value => formatNumber(value, 6)},
        {label: '平均单笔手续费', key: 'avgFeePerOrder', format: value => formatNumber(value, 6)},
        {label: '平均Maker参与度', key: 'makerParticipation', format: value => formatPercent(value, 1)},
        {label: 'Maker订单占比', key: 'makerOrderRatio', format: value => formatPercent(value, 1)},
        {label: '最早成交', key: 'earliest', format: formatDate},
        {label: '最新成交', key: 'latest', format: formatDate}
    ];

    const dashboardState = {
        orders: [],
        tasks: [],
        gridTasks: [],
        selectedTaskId: null
    };

    const taskSelectorEl = document.getElementById('grid-task-selector');
    if (taskSelectorEl) {
        taskSelectorEl.addEventListener('change', event => {
            updateSelectedTaskId(event.target.value);
        });
    }

    async function loadOrders() {
        const res = await fetch('../grid/data/orders.json', {cache: 'no-store'});
        if (!res.ok) {
            throw new Error(`无法加载订单数据：${res.status} ${res.statusText}`);
        }
        return res.json();
    }

    async function loadGridTasks() {
        const res = await fetch('../grid/data/grid_tasks.json', {cache: 'no-store'});
        if (!res.ok) {
            throw new Error(`无法加载网格任务数据：${res.status} ${res.statusText}`);
        }
        return res.json();
    }

    function normalizeOrders(rawOrders) {
        return rawOrders.map(order => {
            const price = safeNumber(order.price);
            const quantity = safeNumber(order.origQty);
            const updateTime = safeNumber(order.updateTime);
            const txFee = safeNumber(order.txFee);
            const makerParticipation = parseMakerFeeRate(order.makerFeeRate);
            const makerFee = Number.isFinite(txFee) && makerParticipation !== null ? txFee * makerParticipation : 0;
            const takerFee = Number.isFinite(txFee) ? Math.max(txFee - makerFee, 0) : 0;
            const takerParticipation = makerParticipation !== null ? Math.max(1 - makerParticipation, 0) : null;
            return {
                ...order,
                price,
                quantity,
                notional: price * quantity,
                updateTime,
                txFee,
                makerFee,
                takerFee,
                makerParticipation,
                takerParticipation
            };
        }).filter(order => Number.isFinite(order.updateTime));
    }

    function toNumberOrNull(value) {
        if (value === undefined || value === null) {
            return null;
        }
        if (typeof value === 'string' && value.trim() === '') {
            return null;
        }
        const num = Number(value);
        return Number.isFinite(num) ? num : null;
    }

    function normalizeGridTasks(rawTasks) {
        if (!Array.isArray(rawTasks)) {
            return [];
        }
        return rawTasks.map(task => {
            const runtime = task && typeof task === 'object' ? task.runtime || {} : {};
            const id = String(task?.id ?? task?.taskId ?? '未命名任务').trim() || '未命名任务';
            const status = task?.status ? String(task.status).toUpperCase() : 'UNKNOWN';
            return {
                id,
                baseAsset: task?.baseAsset ?? task?.baseAssert ?? '',
                quoteAsset: task?.quoteAsset ?? task?.quoteAssert ?? '',
                doubled: Boolean(task?.doubled),
                reversed: Boolean(task?.reversed),
                startPrice: toNumberOrNull(task?.startPrice),
                gridRate: toNumberOrNull(task?.gridRate),
                gridValue: toNumberOrNull(task?.gridValue),
                status,
                runtime: {
                    baseQty: toNumberOrNull(runtime.baseQty),
                    quoteQty: toNumberOrNull(runtime.quoteQty),
                    buyPrice: toNumberOrNull(runtime.buyPrice),
                    sellPrice: toNumberOrNull(runtime.sellPrice),
                    lastTradePrice: toNumberOrNull(runtime.lastTradePrice)
                }
            };
        });
    }

    function safeNumber(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
    }

    function parseMakerFeeRate(value) {
        if (value === undefined || value === null || value === '') {
            return null;
        }
        if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) {
                return null;
            }
            const normalized = trimmed.endsWith('%') ? trimmed.slice(0, -1) : trimmed;
            const num = Number(normalized);
            if (Number.isFinite(num)) {
                return clampPercent(num);
            }
        } else {
            const num = Number(value);
            if (Number.isFinite(num)) {
                return clampPercent(num);
            }
        }
        return null;
    }

    function clampPercent(value) {
        const ratio = value > 1 ? value / 100 : value;
        if (!Number.isFinite(ratio)) {
            return null;
        }
        return Math.min(Math.max(ratio, 0), 1);
    }

    function computeRealizedMetrics(buyQty, sellQty, avgBuyPrice, avgSellPrice) {
        const matchedQty = Math.min(buyQty || 0, sellQty || 0);
        const hasBothSides = matchedQty > 0
            && Number.isFinite(avgBuyPrice)
            && Number.isFinite(avgSellPrice)
            && avgBuyPrice > 0
            && avgSellPrice > 0;
        const priceSpread = hasBothSides ? (avgSellPrice - avgBuyPrice) : 0;
        const realizedProfit = hasBothSides ? matchedQty * priceSpread : 0;
        return {
            matchedQty,
            priceSpread,
            realizedProfit
        };
    }

    function aggregateOrdersBySymbol(orders, side) {
        const map = new Map();
        (orders || []).forEach(order => {
            const symbol = order.symbol || 'UNKNOWN';
            if (!map.has(symbol)) {
                map.set(symbol, {
                    symbol,
                    side,
                    quantity: 0,
                    notional: 0,
                    totalFee: 0,
                    makerParticipationSum: 0,
                    makerParticipationCount: 0,
                    makerNotional: 0,
                    participationNotional: 0,
                    orderCount: 0,
                    earliest: Number.POSITIVE_INFINITY,
                    latest: Number.NEGATIVE_INFINITY,
                    orders: []
                });
            }
            const entry = map.get(symbol);
            const quantity = Number.isFinite(order.quantity) ? order.quantity : 0;
            const notional = Number.isFinite(order.notional) ? order.notional : 0;
            entry.quantity += quantity;
            entry.notional += notional;
            if (Number.isFinite(order.txFee)) {
                entry.totalFee += order.txFee;
            }
            if (Number.isFinite(order.makerParticipation)) {
                entry.makerParticipationSum += order.makerParticipation;
                entry.makerParticipationCount += 1;
                entry.participationNotional += notional;
                entry.makerNotional += notional * order.makerParticipation;
            }
            entry.orderCount += 1;
            if (Number.isFinite(order.updateTime)) {
                entry.earliest = Math.min(entry.earliest, order.updateTime);
                entry.latest = Math.max(entry.latest, order.updateTime);
            }
            entry.orders.push(order);
        });
        return Array.from(map.values()).map(entry => ({
            ...entry,
            avgPrice: entry.quantity ? entry.notional / entry.quantity : 0,
            avgMakerParticipation: entry.makerParticipationCount
                ? entry.makerParticipationSum / entry.makerParticipationCount
                : null,
            makerOrderRatio: entry.participationNotional
                ? entry.makerNotional / entry.participationNotional
                : null,
            earliest: Number.isFinite(entry.earliest) ? entry.earliest : NaN,
            latest: Number.isFinite(entry.latest) ? entry.latest : NaN
        }));
    }

    function buildArbitrageSymbolLegs(arbitrage) {
        const buyLegs = aggregateOrdersBySymbol(arbitrage.buyOrders || [], 'BUY');
        const sellLegs = aggregateOrdersBySymbol(arbitrage.sellOrders || [], 'SELL');
        return [...buyLegs, ...sellLegs].sort((a, b) => {
            if (a.symbol === b.symbol) {
                if (a.side === b.side) {
                    return 0;
                }
                return a.side.localeCompare(b.side);
            }
            return a.symbol.localeCompare(b.symbol);
        });
    }

    function computeSummary(orders) {
        if (!orders.length) {
            return null;
        }

        const totalOrders = orders.length;
        const symbolSet = new Set();
        const taskSet = new Set();

        let totalBuyQty = 0;
        let totalSellQty = 0;
        let totalBuyNotional = 0;
        let totalSellNotional = 0;

        let earliest = Infinity;
        let latest = -Infinity;
        let totalFee = 0;
        let makerFee = 0;
        let takerFee = 0;
        let makerParticipationSum = 0;
        let makerParticipationCount = 0;
        let makerNotional = 0;
        let participationNotional = 0;

        for (const order of orders) {
            symbolSet.add(order.symbol);
            if (order.taskId) {
                taskSet.add(order.taskId);
            }
            if (order.side === 'BUY') {
                totalBuyQty += order.quantity;
                totalBuyNotional += order.notional;
            } else if (order.side === 'SELL') {
                totalSellQty += order.quantity;
                totalSellNotional += order.notional;
            }
            earliest = Math.min(earliest, order.updateTime);
            latest = Math.max(latest, order.updateTime);
            if (Number.isFinite(order.txFee)) {
                totalFee += order.txFee;
            }
            if (Number.isFinite(order.makerFee)) {
                makerFee += order.makerFee;
            }
            if (Number.isFinite(order.takerFee)) {
                takerFee += order.takerFee;
            }
            if (Number.isFinite(order.makerParticipation)) {
                makerParticipationSum += order.makerParticipation;
                makerParticipationCount += 1;
                participationNotional += order.notional;
                makerNotional += order.notional * order.makerParticipation;
            }
        }

        const avgFeePerOrder = totalOrders ? totalFee / totalOrders : 0;
        const makerParticipation = makerParticipationCount
            ? makerParticipationSum / makerParticipationCount
            : null;
        const makerOrderRatio = participationNotional > 0
            ? makerNotional / participationNotional
            : null;

        return {
            totalOrders,
            taskCount: taskSet.size,
            symbolCount: symbolSet.size,
            totalBuyQty,
            totalSellQty,
            totalBuyNotional,
            totalSellNotional,
            netProfit: totalSellNotional - totalBuyNotional,
            totalFee,
            makerFee,
            takerFee,
            avgFeePerOrder,
            makerParticipation,
            makerOrderRatio,
            earliest,
            latest
        };
    }

    function buildTaskHierarchy(orders) {
        const tasksById = new Map();
        for (const order of orders) {
            const taskId = order.taskId || '未命名任务';
            if (!tasksById.has(taskId)) {
                tasksById.set(taskId, {
                    taskId,
                    symbolSet: new Set(),
                    symbolMap: new Map(),
                    arbitrages: new Map(),
                    totalOrders: 0,
                    buyCount: 0,
                    sellCount: 0,
                    buyNotional: 0,
                    sellNotional: 0,
                    totalFee: 0,
                    makerFee: 0,
                    takerFee: 0,
                    makerParticipationSum: 0,
                    makerParticipationCount: 0,
                    makerNotional: 0,
                    participationNotional: 0,
                    start: Number.POSITIVE_INFINITY,
                    end: -Infinity
                });
            }
            const task = tasksById.get(taskId);
            task.symbolSet.add(order.symbol);
            task.totalOrders += 1;
            task.start = Math.min(task.start, order.updateTime);
            task.end = Math.max(task.end, order.updateTime);
            if (order.side === 'BUY') {
                task.buyCount += 1;
                task.buyNotional += order.notional;
            } else if (order.side === 'SELL') {
                task.sellCount += 1;
                task.sellNotional += order.notional;
            }

            if (!task.symbolMap.has(order.symbol)) {
                task.symbolMap.set(order.symbol, {
                    symbol: order.symbol,
                    orderCount: 0,
                    buyQty: 0,
                    sellQty: 0,
                    buyNotional: 0,
                    sellNotional: 0,
                    fee: 0,
                    makerFee: 0,
                    takerFee: 0,
                    makerParticipationSum: 0,
                    makerParticipationCount: 0,
                    makerNotional: 0,
                    participationNotional: 0,
                    lastUpdate: -Infinity
                });
            }
            const symbolStats = task.symbolMap.get(order.symbol);
            symbolStats.orderCount += 1;
            symbolStats.lastUpdate = Math.max(symbolStats.lastUpdate, order.updateTime);
            if (order.side === 'BUY') {
                symbolStats.buyQty += order.quantity;
                symbolStats.buyNotional += order.notional;
            } else if (order.side === 'SELL') {
                symbolStats.sellQty += order.quantity;
                symbolStats.sellNotional += order.notional;
            }
            if (Number.isFinite(order.txFee)) {
                task.totalFee += order.txFee;
                symbolStats.fee += order.txFee;
            }
            if (Number.isFinite(order.makerFee)) {
                task.makerFee += order.makerFee;
                symbolStats.makerFee += order.makerFee;
            }
            if (Number.isFinite(order.takerFee)) {
                task.takerFee += order.takerFee;
                symbolStats.takerFee += order.takerFee;
            }
            const bindId = order.taskBindId || '未分组批次';
            if (!task.arbitrages.has(bindId)) {
                task.arbitrages.set(bindId, {
                    taskBindId: bindId,
                    synthPrice: safeNumber(order.synthPrice),
                    orders: [],
                    buyOrders: [],
                    sellOrders: [],
                    buyNotional: 0,
                    sellNotional: 0,
                    buyQty: 0,
                    sellQty: 0,
                    totalFee: 0,
                    makerFee: 0,
                    takerFee: 0,
                    makerParticipationSum: 0,
                    makerParticipationCount: 0,
                    makerNotional: 0,
                    participationNotional: 0,
                    start: Number.POSITIVE_INFINITY,
                    end: -Infinity
                });
            }
            const arbitrage = task.arbitrages.get(bindId);
            arbitrage.orders.push(order);
            arbitrage.start = Math.min(arbitrage.start, order.updateTime);
            arbitrage.end = Math.max(arbitrage.end, order.updateTime);
            if (!arbitrage.synthPrice && order.synthPrice) {
                arbitrage.synthPrice = safeNumber(order.synthPrice);
            }
            if (order.side === 'BUY') {
                arbitrage.buyOrders.push(order);
                arbitrage.buyNotional += order.notional;
                arbitrage.buyQty += order.quantity;
            } else if (order.side === 'SELL') {
                arbitrage.sellOrders.push(order);
                arbitrage.sellNotional += order.notional;
                arbitrage.sellQty += order.quantity;
            }
            if (Number.isFinite(order.txFee)) {
                arbitrage.totalFee += order.txFee;
            }
            if (Number.isFinite(order.makerFee)) {
                arbitrage.makerFee += order.makerFee;
            }
            if (Number.isFinite(order.takerFee)) {
                arbitrage.takerFee += order.takerFee;
            }
            if (Number.isFinite(order.makerParticipation)) {
                const makerPart = order.makerParticipation;
                const orderNotional = order.notional;
                const makerNotionalShare = orderNotional * makerPart;
                task.makerParticipationSum += makerPart;
                task.makerParticipationCount += 1;
                task.makerNotional += makerNotionalShare;
                task.participationNotional += orderNotional;
                symbolStats.makerParticipationSum += makerPart;
                symbolStats.makerParticipationCount += 1;
                symbolStats.makerNotional += makerNotionalShare;
                symbolStats.participationNotional += orderNotional;
                arbitrage.makerParticipationSum += makerPart;
                arbitrage.makerParticipationCount += 1;
                arbitrage.makerNotional += makerNotionalShare;
                arbitrage.participationNotional += orderNotional;
            }
        }

        return Array.from(tasksById.values())
            .map(task => {
                const arbitrages = Array.from(task.arbitrages.values())
                    .map(arbitrage => {
                        const avgBuyPrice = arbitrage.buyQty ? arbitrage.buyNotional / arbitrage.buyQty : 0;
                        const avgSellPrice = arbitrage.sellQty ? arbitrage.sellNotional / arbitrage.sellQty : 0;
                        const {matchedQty, priceSpread, realizedProfit} = computeRealizedMetrics(
                            arbitrage.buyQty,
                            arbitrage.sellQty,
                            avgBuyPrice,
                            avgSellPrice
                        );
                        const symbolLegs = buildArbitrageSymbolLegs(arbitrage);
                        return {
                            ...arbitrage,
                            profit: arbitrage.sellNotional - arbitrage.buyNotional,
                            status: determineArbitrageStatus(arbitrage),
                            avgBuyPrice,
                            avgSellPrice,
                            matchedQty,
                            priceSpread,
                            realizedProfit,
                            symbolLegs,
                            makerParticipation: arbitrage.makerParticipationCount
                                ? arbitrage.makerParticipationSum / arbitrage.makerParticipationCount
                                : null,
                            makerOrderRatio: arbitrage.participationNotional
                                ? arbitrage.makerNotional / arbitrage.participationNotional
                                : null
                        };
                    })
                    .sort((a, b) => b.end - a.end);
                const symbolStats = Array.from(task.symbolMap.values())
                    .map(symbol => {
                        const avgBuyPrice = symbol.buyQty ? symbol.buyNotional / symbol.buyQty : 0;
                        const avgSellPrice = symbol.sellQty ? symbol.sellNotional / symbol.sellQty : 0;
                        const {matchedQty, priceSpread, realizedProfit} = computeRealizedMetrics(
                            symbol.buyQty,
                            symbol.sellQty,
                            avgBuyPrice,
                            avgSellPrice
                        );
                        return {
                            ...symbol,
                            avgBuyPrice,
                            avgSellPrice,
                            profit: symbol.sellNotional - symbol.buyNotional,
                            priceSpread,
                            matchedQty,
                            realizedProfit,
                            openQty: symbol.buyQty - symbol.sellQty,
                            openNotional: symbol.buyNotional - symbol.sellNotional,
                            totalFee: symbol.fee,
                            makerFeeTotal: symbol.makerFee,
                            takerFeeTotal: symbol.takerFee,
                            makerParticipation: symbol.makerParticipationCount
                                ? symbol.makerParticipationSum / symbol.makerParticipationCount
                                : null,
                            makerOrderRatio: symbol.participationNotional
                                ? symbol.makerNotional / symbol.participationNotional
                                : null
                        };
                    })
                    .sort((a, b) => a.symbol.localeCompare(b.symbol));
                const totalRealizedProfit = symbolStats.reduce((sum, item) => sum + item.realizedProfit, 0);
                const completedCount = arbitrages.filter(item => item.status === '已完成').length;
                const openCount = arbitrages.length - completedCount;
                const netExposureQty = symbolStats.reduce((sum, item) => sum + item.openQty, 0);
                const netExposureNotional = symbolStats.reduce((sum, item) => sum + item.openNotional, 0);
                const latestTrade = arbitrages.length ? arbitrages[0].end : (Number.isFinite(task.end) ? task.end : NaN);
                return {
                    taskId: task.taskId,
                    symbols: Array.from(task.symbolSet).sort(),
                    arbitrages,
                    arbitrageCount: arbitrages.length,
                    completedCount,
                    openCount,
                    totalOrders: task.totalOrders,
                    buyCount: task.buyCount,
                    sellCount: task.sellCount,
                    buyNotional: task.buyNotional,
                    sellNotional: task.sellNotional,
                    profit: task.sellNotional - task.buyNotional,
                    realizedProfit: totalRealizedProfit,
                    netExposureQty,
                    netExposureNotional,
                    symbolStats,
                    latestTrade,
                    totalFee: task.totalFee,
                    makerFee: task.makerFee,
                    takerFee: task.takerFee,
                    makerParticipation: task.makerParticipationCount
                        ? task.makerParticipationSum / task.makerParticipationCount
                        : null,
                    makerOrderRatio: task.participationNotional
                        ? task.makerNotional / task.participationNotional
                        : null,
                    makerParticipationSum: task.makerParticipationSum,
                    makerParticipationCount: task.makerParticipationCount,
                    makerNotional: task.makerNotional,
                    participationNotional: task.participationNotional,
                    start: Number.isFinite(task.start) ? task.start : NaN,
                    end: Number.isFinite(task.end) ? task.end : NaN
                };
            })
            .sort((a, b) => b.end - a.end);
    }

    function createEmptyTaskStats(gridTask) {
        const symbols = [];
        if (gridTask?.baseAsset) {
            symbols.push(String(gridTask.baseAsset));
        }
        if (gridTask?.quoteAsset) {
            symbols.push(String(gridTask.quoteAsset));
        }
        return {
            taskId: gridTask?.id ?? '未命名任务',
            symbols,
            arbitrages: [],
            arbitrageCount: 0,
            completedCount: 0,
            openCount: 0,
            totalOrders: 0,
            buyCount: 0,
            sellCount: 0,
            buyNotional: 0,
            sellNotional: 0,
            profit: 0,
            realizedProfit: 0,
            netExposureQty: 0,
            netExposureNotional: 0,
            symbolStats: [],
            latestTrade: NaN,
            totalFee: 0,
            makerFee: 0,
            takerFee: 0,
            makerParticipation: null,
            makerOrderRatio: null,
            makerParticipationSum: 0,
            makerParticipationCount: 0,
            makerNotional: 0,
            participationNotional: 0,
            start: NaN,
            end: NaN,
            gridTask,
            hasOrders: false
        };
    }

    function createPlaceholderSymbolStats(symbol) {
        return {
            symbol,
            orderCount: 0,
            buyQty: 0,
            sellQty: 0,
            buyNotional: 0,
            sellNotional: 0,
            avgBuyPrice: 0,
            avgSellPrice: 0,
            profit: 0,
            priceSpread: 0,
            matchedQty: 0,
            realizedProfit: 0,
            openQty: 0,
            openNotional: 0,
            totalFee: 0,
            makerFeeTotal: 0,
            takerFeeTotal: 0,
            makerParticipation: null,
            makerOrderRatio: null,
            lastUpdate: NaN
        };
    }

    function composeAssetStats(symbolStats, gridTask) {
        const statsArray = Array.isArray(symbolStats) ? symbolStats : [];
        const statsMap = new Map(statsArray.map(stat => [stat.symbol, stat]));
        const desiredOrder = [];
        if (gridTask?.baseAsset) {
            desiredOrder.push(String(gridTask.baseAsset));
        }
        if (gridTask?.quoteAsset && gridTask.quoteAsset !== gridTask.baseAsset) {
            desiredOrder.push(String(gridTask.quoteAsset));
        }
        const seen = new Set();
        const ordered = [];
        desiredOrder.forEach(symbol => {
            if (!symbol || seen.has(symbol)) {
                return;
            }
            const stats = statsMap.get(symbol);
            ordered.push(stats ? {...stats} : createPlaceholderSymbolStats(symbol));
            seen.add(symbol);
        });
        statsArray.forEach(stat => {
            if (seen.has(stat.symbol)) {
                return;
            }
            ordered.push({...stat});
            seen.add(stat.symbol);
        });
        return ordered;
    }

    function findLegBySymbol(legs, symbol) {
        if (!symbol || !Array.isArray(legs)) {
            return null;
        }
        const normalized = String(symbol).toUpperCase();
        return legs.find(leg => String(leg.symbol).toUpperCase() === normalized) || null;
    }

    function enhanceArbitrageWithGrid(arbitrage, gridTask) {
        const legs = Array.isArray(arbitrage.symbolLegs) ? arbitrage.symbolLegs : [];
        const baseSymbol = gridTask?.baseAsset || gridTask?.baseAssert || null;
        const quoteSymbol = gridTask?.quoteAsset || gridTask?.quoteAssert || null;
        let baseLeg = baseSymbol ? findLegBySymbol(legs, baseSymbol) : null;
        let quoteLeg = quoteSymbol ? findLegBySymbol(legs, quoteSymbol) : null;
        if (!baseLeg && legs.length) {
            baseLeg = legs[0];
        }
        if ((!quoteLeg && legs.length > 1) || (quoteLeg && baseLeg && quoteLeg === baseLeg && legs.length > 1)) {
            quoteLeg = legs.find(leg => leg !== baseLeg) || quoteLeg;
        }
        const baseAvgPrice = baseLeg && Number.isFinite(baseLeg.avgPrice) && baseLeg.avgPrice > 0
            ? baseLeg.avgPrice
            : null;
        const quoteAvgPrice = quoteLeg && Number.isFinite(quoteLeg.avgPrice) && quoteLeg.avgPrice > 0
            ? quoteLeg.avgPrice
            : null;
        let averageCrossRate = null;
        let averageBuyRate = null;
        let averageSellRate = null;
        if (baseAvgPrice && quoteAvgPrice) {
            const rate = baseAvgPrice / quoteAvgPrice;
            averageCrossRate = rate;
            if (baseLeg?.side === 'BUY' && quoteLeg?.side === 'SELL') {
                averageBuyRate = rate;
            } else if (baseLeg?.side === 'SELL' && quoteLeg?.side === 'BUY') {
                averageSellRate = rate;
            }
        }
        return {
            ...arbitrage,
            symbolLegs: legs,
            baseLeg,
            quoteLeg,
            averageCrossRate,
            averageBuyRate,
            averageSellRate
        };
    }

    function mergeGridTasksWithStats(gridTasks, taskStats) {
        const statsById = new Map(taskStats.map(task => [task.taskId, task]));
        const used = new Set();
        const merged = gridTasks.map((gridTask, index) => {
            const stats = statsById.get(gridTask.id);
            if (stats) {
                used.add(gridTask.id);
                return {
                    ...stats,
                    gridTask,
                    hasOrders: stats.totalOrders > 0,
                    gridIndex: index
                };
            }
            return {
                ...createEmptyTaskStats(gridTask),
                gridIndex: index
            };
        });

        const leftovers = taskStats
            .filter(task => !used.has(task.taskId))
            .map(task => ({
                ...task,
                gridTask: null,
                hasOrders: task.totalOrders > 0,
                gridIndex: Number.POSITIVE_INFINITY
            }))
            .sort((a, b) => {
                const aTime = Number.isFinite(a.end) ? a.end : Number.isFinite(a.latestTrade) ? a.latestTrade : 0;
                const bTime = Number.isFinite(b.end) ? b.end : Number.isFinite(b.latestTrade) ? b.latestTrade : 0;
                if (bTime !== aTime) {
                    return bTime - aTime;
                }
                return a.taskId.localeCompare(b.taskId);
            });

        return [...merged, ...leftovers].map(item => {
            const {gridIndex, ...rest} = item;
            const assetStats = composeAssetStats(rest.symbolStats, rest.gridTask);
            const arbitrages = Array.isArray(rest.arbitrages)
                ? rest.arbitrages.map(arbitrage => enhanceArbitrageWithGrid(arbitrage, rest.gridTask))
                : [];
            return {
                ...rest,
                assetStats,
                arbitrages
            };
        });
    }

    function determineDefaultTaskId(tasks) {
        if (!Array.isArray(tasks) || !tasks.length) {
            return null;
        }
        const withOrders = tasks.filter(task => task.totalOrders > 0);
        return (withOrders[0] || tasks[0]).taskId;
    }

    function getTaskById(taskId) {
        if (!taskId) {
            return null;
        }
        return dashboardState.tasks.find(task => task.taskId === taskId) || null;
    }

    function getOrdersByTaskId(taskId) {
        if (!taskId) {
            return [];
        }
        return dashboardState.orders.filter(order => order.taskId === taskId);
    }

    function populateTaskSelector(tasks, selectedTaskId) {
        const selector = document.getElementById('grid-task-selector');
        if (!selector) {
            return;
        }

        selector.innerHTML = '';

        if (!Array.isArray(tasks) || !tasks.length) {
            selector.disabled = true;
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '暂无网格任务';
            selector.appendChild(option);
            selector.value = '';
            return;
        }

        selector.disabled = false;
        tasks.forEach(task => {
            const option = document.createElement('option');
            option.value = task.taskId;
            const pairText = task.gridTask
                ? [task.gridTask.baseAsset, task.gridTask.quoteAsset].filter(Boolean).join('/')
                : (task.symbols && task.symbols.length ? task.symbols.join('/') : '');
            option.textContent = pairText ? `${task.taskId} · ${pairText}` : task.taskId;
            selector.appendChild(option);
        });

        const fallbackId = determineDefaultTaskId(tasks);
        const targetValue = tasks.some(task => task.taskId === selectedTaskId)
            ? selectedTaskId
            : fallbackId;
        selector.value = targetValue || '';
    }

    function renderSelectedTaskOverview(task) {
        const container = document.getElementById('selected-task-overview');
        const emptyHint = document.getElementById('grid-task-empty');
        if (!container || !emptyHint) {
            return;
        }

        container.innerHTML = '';

        if (!task) {
            emptyHint.hidden = false;
            return;
        }

        emptyHint.hidden = true;
        const assetStats = Array.isArray(task.assetStats) ? task.assetStats : [];
        const metrics = [
            {label: '累计已套利利润', value: task.realizedProfit, decimals: 2, isProfit: true},
            {label: '累计名义盈亏', value: task.profit, decimals: 2, isProfit: true},
            {label: '累计手续费', value: task.totalFee, decimals: 6},
            {label: '净持仓名义', value: task.netExposureNotional, decimals: 2, isProfit: true},
            {label: '订单总数', value: task.totalOrders, decimals: 0},
            {label: '套利批次', value: task.arbitrageCount, decimals: 0}
        ];

        const gridTask = task.gridTask || null;
        const pairText = gridTask
            ? [gridTask.baseAsset, gridTask.quoteAsset].filter(Boolean).join(' / ')
            : (task.symbols && task.symbols.length ? task.symbols.join(' / ') : '-');
        const statusLabel = gridTask ? formatGridStatus(gridTask.status) : '未知';
        const gridInfoParts = [];
        if (gridTask && Number.isFinite(gridTask.gridRate)) {
            gridInfoParts.push(`网格间距 ${formatPercent(gridTask.gridRate, 2)}`);
        }
        if (gridTask && Number.isFinite(gridTask.gridValue)) {
            gridInfoParts.push(`单格金额 ${formatNumber(gridTask.gridValue, 2)}`);
        }
        const timeRange = `时间范围：${formatDate(task.start)} ~ ${formatDate(task.end)}`;

        container.innerHTML = `
            <div class="asset-overview">
                <div class="asset-overview-header">
                    <span>任务 <strong>${task.taskId}</strong></span>
                    <span>币对 <strong>${pairText || '-'}</strong></span>
                    <span>状态 <strong>${statusLabel}</strong></span>
                    ${gridInfoParts.length ? `<span>${gridInfoParts.join(' · ')}</span>` : ''}
                </div>
                <div class="asset-metrics-grid">
                    ${metrics.map(renderOverviewMetric).join('')}
                </div>
                ${
            assetStats.length
                ? `<div class="asset-card-grid">${assetStats.map(renderAssetCard).join('')}</div>`
                : '<p class="placeholder">暂无资产成交记录</p>'
        }
                <div class="asset-overview-footer">${timeRange}</div>
            </div>
        `;
    }

    function renderOverviewMetric(metric) {
        const label = metric.label || '-';
        const value = metric.value;
        const decimals = typeof metric.decimals === 'number' ? metric.decimals : 2;
        const isProfit = Boolean(metric.isProfit);
        const isPercent = Boolean(metric.isPercent);
        let displayValue = '-';
        if (isPercent) {
            displayValue = Number.isFinite(value) ? formatPercent(value, decimals) : '-';
        } else if (Number.isFinite(value)) {
            displayValue = formatNumber(value, decimals);
        }
        let valueClass = 'asset-metric-value';
        if (isProfit && Number.isFinite(value)) {
            valueClass += ` ${getProfitClass(value)}`;
        }
        return `
            <div class="asset-metric">
                <span class="asset-metric-label">${label}</span>
                <span class="${valueClass}">${displayValue}</span>
            </div>
        `;
    }

    function renderAssetCard(asset) {
        const metrics = [
            {label: '总买入量', value: asset.buyQty, decimals: 4},
            {label: '总买入金额', value: asset.buyNotional, decimals: 2},
            {label: '平均买入价', value: asset.avgBuyPrice, decimals: 6},
            {label: '总卖出量', value: asset.sellQty, decimals: 4},
            {label: '总卖出金额', value: asset.sellNotional, decimals: 2},
            {label: '平均卖出价', value: asset.avgSellPrice, decimals: 6},
            {label: '价差', value: asset.priceSpread, decimals: 6, isProfit: true},
            {label: '已套利匹配量', value: asset.matchedQty, decimals: 4},
            {label: '已套利利润', value: asset.realizedProfit, decimals: 2, isProfit: true},
            {label: '名义盈亏', value: asset.profit, decimals: 2, isProfit: true},
            {label: '总手续费', value: asset.totalFee, decimals: 6},
            {label: '当前持仓数量', value: asset.openQty, decimals: 4, isProfit: true},
            {label: '当前持仓名义', value: asset.openNotional, decimals: 2, isProfit: true},
            {label: 'Maker订单占比', value: asset.makerOrderRatio, decimals: 1, isPercent: true}
        ];
        const profitValue = Number.isFinite(asset.realizedProfit)
            ? formatNumber(asset.realizedProfit, 2)
            : '-';
        const profitClass = Number.isFinite(asset.realizedProfit)
            ? `asset-card-profit ${getProfitClass(asset.realizedProfit)}`
            : 'asset-card-profit profit-neutral';
        return `
            <div class="asset-card">
                <div class="asset-card-header">
                    <span class="asset-card-title">${asset.symbol || '-'}</span>
                    <span class="${profitClass}">${profitValue}</span>
                </div>
                <div class="asset-card-metrics">
                    ${metrics.map(renderAssetMetric).join('')}
                </div>
                <div class="asset-card-footer">最新成交：${formatDate(asset.lastUpdate)}</div>
            </div>
        `;
    }

    function renderAssetMetric(metric) {
        const label = metric.label || '-';
        const value = metric.value;
        const decimals = typeof metric.decimals === 'number' ? metric.decimals : 2;
        const isProfit = Boolean(metric.isProfit);
        const isPercent = Boolean(metric.isPercent);
        let displayValue = '-';
        if (isPercent) {
            displayValue = Number.isFinite(value) ? formatPercent(value, decimals) : '-';
        } else if (Number.isFinite(value)) {
            displayValue = formatNumber(value, decimals);
        }
        let valueClass = 'asset-card-metric-value';
        if (isProfit && Number.isFinite(value)) {
            valueClass += ` ${getProfitClass(value)}`;
        }
        return `
            <div class="asset-card-metric">
                <span class="asset-card-metric-label">${label}</span>
                <span class="${valueClass}">${displayValue}</span>
            </div>
        `;
    }

    function renderDashboard() {
        const taskId = dashboardState.selectedTaskId;
        const selectedTask = getTaskById(taskId);
        const filteredOrders = getOrdersByTaskId(taskId);
        const summary = filteredOrders.length ? computeSummary(filteredOrders) : null;

        renderSelectedTaskOverview(selectedTask);
        renderSummary(summary);
        renderTaskHierarchy(dashboardState.tasks, taskId);
        renderTimeline(filteredOrders);
        renderProfitOverview(summary, selectedTask);
        updateSectionIndicators(taskId);
    }

    const GRID_STATUS_LABELS = {
        RUNNING: '运行中',
        ACTIVE: '运行中',
        PAUSED: '已暂停',
        IDLE: '待启动',
        STOPPED: '已停止',
        FINISHED: '已结束',
        COMPLETED: '已结束',
        ERROR: '异常',
        FAILED: '异常',
        WAITING: '待启动',
        UNKNOWN: '未知'
    };

    function formatGridStatus(status) {
        if (!status) {
            return GRID_STATUS_LABELS.UNKNOWN;
        }
        const normalized = String(status).toUpperCase();
        return GRID_STATUS_LABELS[normalized] || normalized;
    }

    function getStatusClass(status) {
        if (!status) {
            return 'status-unknown';
        }
        const normalized = String(status).toUpperCase();
        if (normalized === 'RUNNING' || normalized === 'ACTIVE') {
            return 'status-running';
        }
        if (normalized === 'PAUSED' || normalized === 'WAITING' || normalized === 'IDLE') {
            return 'status-idle';
        }
        if (normalized === 'STOPPED') {
            return 'status-stopped';
        }
        if (normalized === 'FINISHED' || normalized === 'COMPLETED') {
            return 'status-finished';
        }
        if (normalized === 'ERROR' || normalized === 'FAILED') {
            return 'status-error';
        }
        return 'status-unknown';
    }

    function formatBoolean(value) {
        if (value === undefined || value === null) {
            return '-';
        }
        return value ? '是' : '否';
    }

    function formatValueWithUnit(value, unit = '', decimals = 2) {
        if (!Number.isFinite(value)) {
            return '-';
        }
        const formatted = formatNumber(value, decimals);
        return unit ? `${formatted} ${unit}` : formatted;
    }

    function hasRuntimeData(runtime) {
        if (!runtime || typeof runtime !== 'object') {
            return false;
        }
        return ['baseQty', 'quoteQty', 'buyPrice', 'sellPrice', 'lastTradePrice'].some(key => Number.isFinite(runtime[key]));
    }

    function renderConfigItem(label, value) {
        return `
            <div class="grid-config-item">
                <span class="config-label">${label}</span>
                <span class="config-value">${value}</span>
            </div>
        `;
    }

    function createGridConfig(gridTask) {
        if (!gridTask) {
            return '';
        }
        const pair = [gridTask.baseAsset, gridTask.quoteAsset].filter(Boolean).join(' / ') || '-';
        const sections = [];
        sections.push(`
            <div class="grid-config-section">
                <div class="grid-config-title">任务参数</div>
                <div class="grid-config-grid">
                    ${renderConfigItem('网格任务', gridTask.id)}
                    ${renderConfigItem('基础资产', gridTask.baseAsset || '-')}
                    ${renderConfigItem('报价资产', gridTask.quoteAsset || '-')}
                    ${renderConfigItem('标的组合', pair)}
                    ${renderConfigItem('起始价', formatNumber(gridTask.startPrice, 6))}
                    ${renderConfigItem('网格间距', formatPercent(gridTask.gridRate, 2))}
                    ${renderConfigItem('单格金额', formatValueWithUnit(gridTask.gridValue, 'USDT', 2))}
                    ${renderConfigItem('双向执行', formatBoolean(gridTask.doubled))}
                    ${renderConfigItem('反向套利', formatBoolean(gridTask.reversed))}
                </div>
            </div>
        `);

        if (hasRuntimeData(gridTask.runtime)) {
            const runtime = gridTask.runtime || {};
            sections.push(`
                <div class="grid-config-section">
                    <div class="grid-config-title">运行状态</div>
                    <div class="grid-config-grid">
                        ${renderConfigItem('基础资产持仓', formatNumber(runtime.baseQty, 4))}
                        ${renderConfigItem('报价资产持仓', formatNumber(runtime.quoteQty, 4))}
                        ${renderConfigItem('当前买入价', formatNumber(runtime.buyPrice, 6))}
                        ${renderConfigItem('当前卖出价', formatNumber(runtime.sellPrice, 6))}
                        ${renderConfigItem('最新成交价', formatNumber(runtime.lastTradePrice, 6))}
                    </div>
                </div>
            `);
        }

        return `<div class="grid-config">${sections.join('')}</div>`;
    }

    function createRuntimeSummary(gridTask) {
        if (!gridTask) {
            return '';
        }
        const runtime = gridTask.runtime || {};
        const segments = [];
        if (Number.isFinite(runtime.baseQty) || Number.isFinite(runtime.quoteQty)) {
            segments.push(`持仓 ${formatNumber(runtime.baseQty, 4)} / ${formatNumber(runtime.quoteQty, 4)}`);
        }
        if (Number.isFinite(runtime.buyPrice) || Number.isFinite(runtime.sellPrice)) {
            segments.push(`挂单 买 ${formatNumber(runtime.buyPrice, 6)} / 卖 ${formatNumber(runtime.sellPrice, 6)}`);
        }
        if (Number.isFinite(runtime.lastTradePrice)) {
            segments.push(`最新成交 ${formatNumber(runtime.lastTradePrice, 6)}`);
        }
        return segments.join(' · ');
    }

    function renderSummary(summary) {
        const summaryContainer = document.getElementById('summary');
        const emptyHint = document.getElementById('summary-empty');
        summaryContainer.innerHTML = '';

        if (!summary) {
            emptyHint.hidden = false;
            return;
        }

        emptyHint.hidden = true;
        SUMMARY_CONFIG.forEach(item => {
            const value = summary[item.key];
            const formatter = item.format || (val => formatNumber(val, 0));
            const extraClass = item.getClass ? item.getClass(value) : '';
            const card = document.createElement('div');
            card.className = 'summary-item';
            card.innerHTML = `
                <span class="summary-label">${item.label}</span>
                <span class="summary-value ${extraClass}">${formatter(value)}</span>
            `;
            summaryContainer.appendChild(card);
        });
    }

    function updateSectionIndicators(taskId) {
        const text = taskId ? `当前任务：${taskId}` : '当前任务：-';
        const taskIndicator = document.getElementById('task-filter-indicator');
        const timelineIndicator = document.getElementById('timeline-filter-indicator');
        if (taskIndicator) {
            taskIndicator.textContent = text;
        }
        if (timelineIndicator) {
            timelineIndicator.textContent = text;
        }
    }

    function updateSelectedTaskId(taskId) {
        const tasks = dashboardState.tasks;
        if (!tasks.length) {
            dashboardState.selectedTaskId = null;
        } else {
            const exists = tasks.some(task => task.taskId === taskId);
            dashboardState.selectedTaskId = exists ? taskId : determineDefaultTaskId(tasks);
        }

        const selector = document.getElementById('grid-task-selector');
        if (selector) {
            const desiredValue = dashboardState.selectedTaskId || '';
            if (selector.value !== desiredValue) {
                selector.value = desiredValue;
            }
        }

        renderDashboard();

        if (dashboardState.selectedTaskId) {
            requestAnimationFrame(() => {
                const target = document.querySelector(`details[data-task-id="${dashboardState.selectedTaskId}"]`);
                if (target) {
                    target.open = true;
                    target.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            });
        }
    }

    function renderTaskHierarchy(tasks, selectedTaskId) {
        const container = document.getElementById('task-hierarchy');
        const emptyHint = document.getElementById('task-empty');
        container.innerHTML = '';

        const filtered = selectedTaskId ? tasks.filter(task => task.taskId === selectedTaskId) : tasks;

        if (!filtered.length) {
            emptyHint.hidden = false;
            return;
        }

        emptyHint.hidden = true;
        filtered.forEach((task, index) => {
            const details = document.createElement('details');
            details.className = 'task-block';
            details.dataset.taskId = task.taskId;
            if (index === 0) {
                details.open = true;
            }

            const summary = document.createElement('summary');
            summary.innerHTML = createTaskSummary(task);
            details.appendChild(summary);

            const content = document.createElement('div');
            content.className = 'task-block-content';

            if (task.gridTask) {
                content.insertAdjacentHTML('beforeend', createGridConfig(task.gridTask));
            }

            const symbolSection = document.createElement('div');
            symbolSection.className = 'symbol-summary';
            symbolSection.innerHTML = createSymbolSummaryTable(task.symbolStats || []);
            content.appendChild(symbolSection);

            if (task.arbitrages && task.arbitrages.length) {
                const table = document.createElement('table');
                table.className = 'arbitrage-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>批次ID</th>
                            <th>交易汇率</th>
                            <th>交易方向</th>
                            <th class="text-right">交易金额 (USDT)</th>
                            <th class="text-right">交易总手续费</th>
                            <th class="text-right">已套利利润</th>
                            <th>状态</th>
                            <th>时间</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                const arbitrageRows = task.arbitrages.slice(0, 5);
                const columnCount = table.querySelector('thead tr').children.length || 1;
                arbitrageRows.forEach((arbitrage, index) => {
                    const summaryRow = document.createElement('tr');
                    summaryRow.className = 'arbitrage-summary-row';
                    summaryRow.innerHTML = createArbitrageSummaryCells(arbitrage, task);
                    summaryRow.tabIndex = 0;
                    summaryRow.setAttribute('role', 'button');
                    summaryRow.setAttribute('aria-expanded', index === 0 ? 'true' : 'false');

                    const detailRow = document.createElement('tr');
                    detailRow.className = 'arbitrage-detail-row';
                    if (index !== 0) {
                        detailRow.hidden = true;
                    }
                    const detailCell = document.createElement('td');
                    detailCell.colSpan = columnCount;
                    detailCell.innerHTML = createArbitrageDetail(arbitrage, task);
                    detailRow.appendChild(detailCell);

                    summaryRow.addEventListener('click', () => {
                        toggleArbitrageDetail(summaryRow, detailRow, tbody);
                    });
                    summaryRow.addEventListener('keydown', event => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            toggleArbitrageDetail(summaryRow, detailRow, tbody);
                        }
                    });

                    tbody.appendChild(summaryRow);
                    tbody.appendChild(detailRow);
                });
                table.appendChild(tbody);
                content.appendChild(table);
                if (task.arbitrages.length > arbitrageRows.length) {
                    const note = document.createElement('p');
                    note.className = 'placeholder';
                    note.textContent = `仅显示最新 ${arbitrageRows.length} 个批次`;
                    content.appendChild(note);
                }
            } else {
                const placeholder = document.createElement('p');
                placeholder.className = 'placeholder';
                placeholder.textContent = task.hasOrders
                    ? '暂无套利批次统计。'
                    : '暂无成交记录，等待订单数据。';
                content.appendChild(placeholder);
            }
            details.appendChild(content);
            container.appendChild(details);
        });
    }

    function createSymbolSummaryTable(symbolStats) {
        if (!symbolStats.length) {
            return '<p class="placeholder">暂无交易对统计</p>';
        }
        const rows = symbolStats.map(symbol => {
            const avgBuy = symbol.buyQty > 0 ? formatNumber(symbol.avgBuyPrice, 6) : '-';
            const avgSell = symbol.sellQty > 0 ? formatNumber(symbol.avgSellPrice, 6) : '-';
            const profitClass = getProfitClass(symbol.profit);
            const makerRatio = symbol.makerOrderRatio;
            return `
                <tr>
                    <td>${symbol.symbol}</td>
                    <td class="text-right">${formatNumber(symbol.buyQty, 4)}</td>
                    <td class="text-right">${avgBuy}</td>
                    <td class="text-right">${formatNumber(symbol.sellQty, 4)}</td>
                    <td class="text-right">${avgSell}</td>
                    <td class="text-right"><span class="${profitClass}">${formatNumber(symbol.profit, 2)}</span></td>
                    <td class="text-right">${formatNumber(symbol.openQty, 4)}</td>
                    <td class="text-right">${formatNumber(symbol.totalFee, 6)}</td>
                    <td class="text-right">${formatPercent(makerRatio, 1)}</td>
                    <td>${formatDate(symbol.lastUpdate)}</td>
                </tr>
            `;
        }).join('');
        return `
            <h3 class="symbol-summary-title">交易币对概览</h3>
            <table class="symbol-summary-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th class="text-right">买入量</th>
                        <th class="text-right">平均买价</th>
                        <th class="text-right">卖出量</th>
                        <th class="text-right">平均卖价</th>
                        <th class="text-right">名义盈亏</th>
                        <th class="text-right">未平仓量</th>
                        <th class="text-right">手续费</th>
                        <th class="text-right">Maker占比</th>
                        <th>最近成交</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    function createTaskSummary(task) {
        const symbolsText = task.symbols.length ? task.symbols.join('、') : '-';
        const arbitrageSummary = `套利批次 ${formatNumber(task.arbitrageCount, 0)}（完成 ${formatNumber(task.completedCount, 0)} / 未平 ${formatNumber(task.openCount, 0)}）`;
        const orderSummary = `订单 ${formatNumber(task.totalOrders, 0)}（买 ${formatNumber(task.buyCount, 0)} / 卖 ${formatNumber(task.sellCount, 0)}）`;
        const exposureLine = `未平仓量 ${formatNumber(task.netExposureQty, 4)} · 名义 ${formatNumber(task.netExposureNotional, 2)}`;
        const timeRange = (Number.isFinite(task.start) || Number.isFinite(task.end))
            ? `${formatDate(task.start)} ~ ${formatDate(task.end)}`
            : '暂无成交时间';
        const statusBadge = task.gridTask
            ? `<span class="status-badge ${getStatusClass(task.gridTask.status)}">${formatGridStatus(task.gridTask.status)}</span>`
            : `<span class="status-badge status-unknown">未登记</span>`;
        const gridLine = task.gridTask
            ? `网格间距 ${formatPercent(task.gridTask.gridRate, 2)} · 单格 ${formatValueWithUnit(task.gridTask.gridValue, 'USDT', 2)}`
            : '未在 grid_tasks.json 中找到该任务配置';
        const runtimeLine = task.gridTask ? createRuntimeSummary(task.gridTask) : '';

        return `
            <div class="task-header">
                <div>
                    <div class="task-title-row">
                        ${statusBadge}
                        <span class="task-title">${task.taskId}</span>
                    </div>
                    <div class="task-subtitle">符号：${symbolsText}</div>
                    <div class="task-subtitle">${gridLine}</div>
                    ${runtimeLine ? `<div class="task-subtitle">${runtimeLine}</div>` : ''}
                    <div class="task-subtitle">${arbitrageSummary}</div>
                    <div class="task-subtitle">${orderSummary}</div>
                    <div class="task-subtitle">${exposureLine}</div>
                    <div class="task-subtitle">时间：${timeRange}</div>
                </div>
                <div class="task-metrics">
                    <div class="task-metric">
                        <span class="metric-label">名义盈亏</span>
                        <span class="metric-value ${getProfitClass(task.profit)}">${formatNumber(task.profit, 2)}</span>
                    </div>
                    <div class="task-metric">
                        <span class="metric-label">手续费总额</span>
                        <span class="metric-value">${formatNumber(task.totalFee, 6)}</span>
                    </div>
                    <div class="task-metric">
                        <span class="metric-label">Maker订单占比</span>
                        <span class="metric-value">${formatPercent(task.makerOrderRatio, 1)}</span>
                    </div>
                    <div class="task-metric">
                        <span class="metric-label">平均Maker参与度</span>
                        <span class="metric-value">${formatPercent(task.makerParticipation, 1)}</span>
                    </div>
                    <div class="task-metric">
                        <span class="metric-label">最新成交</span>
                        <span class="metric-value">${formatDate(task.latestTrade)}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function createArbitrageSummaryCells(arbitrage, task) {
        const totalFee = (Number.isFinite(arbitrage.baseLeg?.totalFee) ? arbitrage.baseLeg.totalFee : 0)
            + (Number.isFinite(arbitrage.quoteLeg?.totalFee) ? arbitrage.quoteLeg.totalFee : 0);
        const synthRate = Number.isFinite(arbitrage.synthPrice) ? formatNumber(arbitrage.synthPrice, 6) : '-';
        const realizedProfit = Number.isFinite(arbitrage.realizedProfit) ? formatNumber(arbitrage.realizedProfit, 2) : '-';
        const baseDirection = arbitrage.baseLeg?.side === 'BUY' ? '买入' : arbitrage.baseLeg?.side === 'SELL' ? '卖出' : '-';
        const baseAmountValue = Number.isFinite(arbitrage.baseLeg?.notional)
            ? formatNumber(arbitrage.baseLeg.notional, 2)
            : '-';
        const totalFeeText = Number.isFinite(totalFee) ? formatNumber(totalFee, 6) : '-';
        const statusText = arbitrage.status || '-';
        const profitClass = getProfitClass(arbitrage.realizedProfit);
        const realizedProfitText = Number.isFinite(arbitrage.realizedProfit) ? realizedProfit : '-';
        const baseTimeStart = Number.isFinite(arbitrage.baseLeg?.earliest) ? formatDate(arbitrage.baseLeg.earliest) : formatDate(arbitrage.start);
        const baseTimeEnd = Number.isFinite(arbitrage.baseLeg?.latest) ? formatDate(arbitrage.baseLeg.latest) : formatDate(arbitrage.end);
        const timeLabel = `${baseTimeStart}<br><small>${baseTimeEnd}</small>`;
        return `
            <td class="arbitrage-id-cell">${arbitrage.taskBindId}</td>
            <td>${synthRate}</td>
            <td>${baseDirection}</td>
            <td class="text-right">${baseAmountValue}</td>
            <td class="text-right">${totalFeeText}</td>
            <td class="text-right arbitrage-summary-profit-cell"><span class="${profitClass}">${realizedProfitText}</span></td>
            <td>${statusText}</td>
            <td>${timeLabel}</td>
        `;
    }

    function createArbitrageDetail(arbitrage, task) {
        const baseLabel = task?.gridTask?.baseAsset || task?.gridTask?.baseAssert || arbitrage.baseLeg?.symbol || 'Base';
        const quoteLabel = task?.gridTask?.quoteAsset || task?.gridTask?.quoteAssert || arbitrage.quoteLeg?.symbol || 'Quote';
        const baseOrders = renderArbitrageOrderRows(arbitrage.baseLeg, 'Base');
        const quoteOrders = renderArbitrageOrderRows(arbitrage.quoteLeg, 'Quote');
        return `
            <div class="arbitrage-detail">
                <div class="arbitrage-detail-legs">
                    <div class="arbitrage-orders-table-wrapper">
                        <table class="arbitrage-orders-table">
                            <thead>
                                <tr>
                                    <th>腿</th>
                                    <th>订单ID</th>
                                    <th>方向</th>
                                    <th>Symbol</th>
                                    <th class="text-right">数量</th>
                                    <th class="text-right">价格</th>
                                    <th class="text-right">金额</th>
                                    <th class="text-right">手续费</th>
                                    <th class="text-right">Maker占比</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${baseOrders}
                                ${quoteOrders}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderArbitrageOrderRows(leg, label) {
        if (!leg || !Array.isArray(leg.orders) || !leg.orders.length) {
            return `
                <tr>
                    <td>${label}</td>
                    <td colspan="9"><span class="placeholder">暂无订单</span></td>
                </tr>
            `;
        }
        const rows = leg.orders
            .slice()
            .sort((a, b) => a.updateTime - b.updateTime)
            .map(order => {
                const orderId = order.orderId || order.clientOrderId || '-';
                const maker = order.makerFeeRate
                    || (Number.isFinite(order.makerParticipation) ? formatPercent(order.makerParticipation, 1) : '-');
                return `
                    <tr>
                        <td>${label}</td>
                        <td>${orderId}</td>
                        <td>${order.side || '-'}</td>
                        <td>${order.symbol || '-'}</td>
                        <td class="text-right">${formatNumber(order.quantity, 4)}</td>
                        <td class="text-right">${formatNumber(order.price, 6)}</td>
                        <td class="text-right">${formatNumber(order.notional, 2)}</td>
                        <td class="text-right">${formatNumber(order.txFee, 6)}</td>
                        <td class="text-right">${maker}</td>
                        <td>${formatDate(order.updateTime)}</td>
                    </tr>
                `;
            })
            .join('');
        return rows;
    }

    function renderLegSummaryLine(leg, label, symbolLabel) {
        if (!leg) {
            return '';
        }
        const direction = leg.side === 'BUY' ? '买入' : leg.side === 'SELL' ? '卖出' : '-';
        const quantity = Number.isFinite(leg.quantity) ? formatNumber(leg.quantity, 6) : '-';
        const avgPrice = Number.isFinite(leg.avgPrice) ? formatNumber(leg.avgPrice, 6) : '-';
        const notional = Number.isFinite(leg.notional) ? formatNumber(leg.notional, 2) : '-';
        const fee = Number.isFinite(leg.totalFee) ? formatNumber(leg.totalFee, 6) : '-';
        const maker = Number.isFinite(leg.makerOrderRatio) ? formatPercent(leg.makerOrderRatio, 1) : '-';
        const symbol = symbolLabel || leg.symbol || label;
        return `
            <div class="rate-line">${label} ${symbol} · ${direction} 数量 ${quantity} · 均价 ${avgPrice} · 金额 ${notional} USDT · 手续费 ${fee} · Maker ${maker}</div>
        `;
    }

    function toggleArbitrageDetail(summaryRow, detailRow, tbody) {
        const isHidden = detailRow.hidden;
        const summaryRows = Array.from(tbody.querySelectorAll('tr.arbitrage-summary-row'));
        const detailRows = Array.from(tbody.querySelectorAll('tr.arbitrage-detail-row'));
        detailRows.forEach((row, index) => {
            const summary = summaryRows[index];
            if (row === detailRow) {
                const shouldOpen = isHidden;
                row.hidden = !shouldOpen;
                summary.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
            } else {
                row.hidden = true;
                summary.setAttribute('aria-expanded', 'false');
            }
        });
    }

    function renderArbitrageRates(arbitrage, baseLabel, quoteLabel) {
        const lines = [];
        if (Number.isFinite(arbitrage.averageBuyRate)) {
            lines.push(`买入 ${baseLabel}/${quoteLabel} ${formatNumber(arbitrage.averageBuyRate, 6)}`);
        }
        if (Number.isFinite(arbitrage.averageSellRate)) {
            lines.push(`卖出 ${baseLabel}/${quoteLabel} ${formatNumber(arbitrage.averageSellRate, 6)}`);
        }
        if (!lines.length && Number.isFinite(arbitrage.averageCrossRate)) {
            lines.push(`平均 ${baseLabel}/${quoteLabel} ${formatNumber(arbitrage.averageCrossRate, 6)}`);
        }
        if (Number.isFinite(arbitrage.synthPrice)) {
            lines.push(`合成 ${formatNumber(arbitrage.synthPrice, 6)}`);
        }
        if (!lines.length) {
            return '<span class="placeholder">-</span>';
        }
        return lines.map(line => `<div class="rate-line">${line}</div>`).join('');
    }

    function determineArbitrageStatus(arbitrage) {
        const hasBuy = arbitrage.buyOrders.length > 0;
        const hasSell = arbitrage.sellOrders.length > 0;
        if (hasBuy && hasSell) {
            return '已完成';
        }
        if (hasBuy) {
            return '待卖出';
        }
        if (hasSell) {
            return '待买入';
        }
        return '待交易';
    }

    function renderTimeline(orders) {
        const tbody = document.getElementById('timeline-table');
        const emptyHint = document.getElementById('timeline-empty');
        tbody.innerHTML = '';

        if (!orders.length) {
            emptyHint.hidden = false;
            return;
        }

        emptyHint.hidden = true;
        orders.slice().reverse().slice(0, 10).forEach(order => {
            const orderIdDisplay = order.orderId || order.clientOrderId || '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${orderIdDisplay}</td>
                <td><span class="badge ${order.side === 'BUY' ? 'badge-buy' : 'badge-sell'}">${order.side}</span></td>
                <td>${order.symbol}</td>
                <td class="text-right">${formatNumber(order.quantity, 4)}</td>
                <td class="text-right">${formatNumber(order.price, 6)}</td>
                <td class="text-right">${formatNumber(order.notional, 2)}</td>
                <td class="text-right">${formatNumber(order.txFee, 6)}</td>
                <td>${order.makerFeeRate || formatPercent(order.makerParticipation, 1)}</td>
                <td>${order.status || '-'}</td>
                <td>${formatDate(order.updateTime)}</td>
                <td>${order.taskBindId || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function formatNumber(value, decimals) {
        if (!Number.isFinite(value)) {
            return '-';
        }
        return value.toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatPercent(value, decimals = 1) {
        if (!Number.isFinite(value)) {
            return '-';
        }
        return `${formatNumber(value * 100, decimals)}%`;
    }

    function formatDate(timestamp) {
        if (!Number.isFinite(timestamp) || timestamp <= 0) {
            return '-';
        }
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) {
            return '-';
        }
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    function updateMeta(text) {
        document.getElementById('source-meta').textContent = text;
        document.getElementById('last-refresh').textContent = `最后更新：${formatDate(Date.now())}`;
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.textContent = message;
        errorEl.hidden = false;
    }

    function renderProfitOverview(summary, selectedTask) {
        const totalEl = document.getElementById('profit-total');
        const avgEl = document.getElementById('profit-average');
        const positiveEl = document.getElementById('profit-positive-count');
        const negativeEl = document.getElementById('profit-negative-count');
        const winnersList = document.getElementById('profit-winners');
        const losersList = document.getElementById('profit-losers');

        const hasData = Boolean(summary && selectedTask);

        const totalProfit = hasData ? summary.netProfit : 0;
        const totalCompletedArbs = hasData ? selectedTask.completedCount : 0;
        const avgProfit = hasData && totalCompletedArbs ? totalProfit / totalCompletedArbs : null;
        const profitableTasks = hasData && totalProfit > 0 ? 1 : 0;
        const riskyTasks = hasData && (totalProfit < 0 || selectedTask.openCount > 0) ? 1 : 0;

        totalEl.textContent = hasData ? formatNumber(totalProfit, 2) : '-';
        totalEl.className = `profit-value ${getProfitClass(totalProfit)}`;
        avgEl.textContent = avgProfit !== null ? formatNumber(avgProfit, 2) : '-';
        avgEl.className = avgProfit !== null
            ? `profit-value ${getProfitClass(avgProfit)}`
            : 'profit-value profit-neutral';
        positiveEl.textContent = hasData ? formatNumber(profitableTasks, 0) : '-';
        positiveEl.className = hasData ? 'profit-value profit-positive' : 'profit-value profit-neutral';
        negativeEl.textContent = hasData ? formatNumber(riskyTasks, 0) : '-';
        negativeEl.className = hasData
            ? `profit-value ${riskyTasks ? 'profit-negative' : 'profit-neutral'}`
            : 'profit-value profit-neutral';

        winnersList.innerHTML = '';
        losersList.innerHTML = '';

        if (!hasData) {
            winnersList.innerHTML = `<li class="leader-empty">暂无数据</li>`;
            losersList.innerHTML = `<li class="leader-empty">暂无数据</li>`;
            return;
        }

        if (totalProfit > 0) {
            const li = document.createElement('li');
            li.className = 'leader-entry';
            li.innerHTML = `
                <span>${selectedTask.taskId}</span>
                <span class="${getProfitClass(totalProfit)}">${formatNumber(totalProfit, 2)}</span>
            `;
            winnersList.appendChild(li);
        } else {
            winnersList.innerHTML = `<li class="leader-empty">暂无盈利任务</li>`;
        }

        if (totalProfit < 0) {
            const li = document.createElement('li');
            li.className = 'leader-entry';
            li.innerHTML = `
                <span>${selectedTask.taskId}</span>
                <span class="${getProfitClass(totalProfit)}">${formatNumber(totalProfit, 2)}</span>
            `;
            losersList.appendChild(li);
        } else if (selectedTask.openCount > 0) {
            const li = document.createElement('li');
            li.className = 'leader-entry';
            li.innerHTML = `
                <span>${selectedTask.taskId}</span>
                <span class="profit-neutral">存在未平批次</span>
            `;
            losersList.appendChild(li);
        } else {
            losersList.innerHTML = `<li class="leader-empty">暂无亏损任务</li>`;
        }
    }

    function getProfitClass(value) {
        if (!Number.isFinite(value) || Math.abs(value) < 1e-12) {
            return 'profit-neutral';
        }
        return value > 0 ? 'profit-positive' : 'profit-negative';
    }

    async function init() {
        updateMeta('正在加载网格任务与订单数据...');
        const errorEl = document.getElementById('error-message');
        if (errorEl) {
            errorEl.hidden = true;
            errorEl.textContent = '';
        }
        const [gridResult, orderResult] = await Promise.allSettled([
            loadGridTasks(),
            loadOrders()
        ]);

        let gridTasksRaw = [];
        if (gridResult.status === 'fulfilled') {
            gridTasksRaw = Array.isArray(gridResult.value) ? gridResult.value : [];
        } else {
            const error = gridResult.reason instanceof Error ? gridResult.reason.message : '加载网格任务数据失败';
            showError(error);
        }

        let normalizedOrders = [];
        if (orderResult.status === 'fulfilled') {
            const payload = orderResult.value || {};
            normalizedOrders = normalizeOrders(payload.orders || []);
            normalizedOrders.sort((a, b) => a.updateTime - b.updateTime);
        } else {
            const error = orderResult.reason instanceof Error ? orderResult.reason.message : '加载订单数据失败';
            showError(error);
        }

        const normalizedGridTasks = normalizeGridTasks(gridTasksRaw);
        const taskHierarchy = buildTaskHierarchy(normalizedOrders);
        const mergedTasks = mergeGridTasksWithStats(normalizedGridTasks, taskHierarchy);
        dashboardState.orders = normalizedOrders;
        dashboardState.tasks = mergedTasks;
        dashboardState.gridTasks = normalizedGridTasks;
        dashboardState.selectedTaskId = determineDefaultTaskId(mergedTasks);

        populateTaskSelector(mergedTasks, dashboardState.selectedTaskId);
        renderDashboard();

        const gridMeta = `${normalizedGridTasks.length} 个网格任务（../grid/data/grid_tasks.json）`;
        const orderMeta = normalizedOrders.length
            ? `${normalizedOrders.length} 条订单（../grid/data/orders.json）`
            : '暂无订单数据';
        updateMeta(`数据源：${gridMeta} · ${orderMeta}`);
    }

    init();
</script>
</body>
</html>
